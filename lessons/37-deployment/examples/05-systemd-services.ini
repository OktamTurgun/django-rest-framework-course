# ============================================================================
# Systemd Service Files for Django REST API
# ============================================================================
# These are example systemd service files for production deployment
# Copy to /etc/systemd/system/ and customize as needed
# ============================================================================


# ============================================================================
# 1. GUNICORN SERVICE
# ============================================================================
# File: /etc/systemd/system/gunicorn.service
# Description: Main application server

[Unit]
Description=Gunicorn daemon for Django Library API
Requires=gunicorn.socket
After=network.target postgresql.service redis.service

[Service]
Type=notify
# User and Group
User=www-data
Group=www-data

# Working Directory
WorkingDirectory=/var/www/library-api

# Environment
Environment="PATH=/var/www/library-api/venv/bin"
Environment="DJANGO_SETTINGS_MODULE=config.settings.production"

# Execute Command
ExecStart=/var/www/library-api/venv/bin/gunicorn \
          --config /var/www/library-api/gunicorn_config.py \
          --workers 3 \
          --bind unix:/run/gunicorn/gunicorn.sock \
          config.wsgi:application

# Process Management
ExecReload=/bin/kill -s HUP $MAINPID
KillMode=mixed
TimeoutStopSec=5
PrivateTmp=true

# Restart Policy
Restart=always
RestartSec=3

# Security
NoNewPrivileges=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/var/www/library-api/media /var/www/library-api/logs

# Resource Limits
LimitNOFILE=65535
LimitNPROC=4096

[Install]
WantedBy=multi-user.target


# ============================================================================
# 2. GUNICORN SOCKET
# ============================================================================
# File: /etc/systemd/system/gunicorn.socket
# Description: Socket activation for Gunicorn

[Unit]
Description=Gunicorn socket

[Socket]
ListenStream=/run/gunicorn/gunicorn.sock
SocketUser=www-data
SocketGroup=www-data
SocketMode=0660

[Install]
WantedBy=sockets.target


# ============================================================================
# 3. GUNICORN MULTIPLE INSTANCES (Load Balancing)
# ============================================================================
# File: /etc/systemd/system/gunicorn@.service
# Description: Template for multiple Gunicorn instances

[Unit]
Description=Gunicorn daemon for Django Library API (instance %i)
After=network.target postgresql.service

[Service]
Type=notify
User=www-data
Group=www-data
WorkingDirectory=/var/www/library-api
Environment="PATH=/var/www/library-api/venv/bin"
Environment="DJANGO_SETTINGS_MODULE=config.settings.production"

# Bind to different ports based on instance number
ExecStart=/var/www/library-api/venv/bin/gunicorn \
          --config /var/www/library-api/gunicorn_config.py \
          --bind 127.0.0.1:800%i \
          config.wsgi:application

ExecReload=/bin/kill -s HUP $MAINPID
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target

# Usage:
# sudo systemctl enable gunicorn@1.service
# sudo systemctl enable gunicorn@2.service
# sudo systemctl enable gunicorn@3.service
# sudo systemctl start gunicorn@{1..3}


# ============================================================================
# 4. CELERY WORKER SERVICE
# ============================================================================
# File: /etc/systemd/system/celery.service
# Description: Celery worker for async tasks

[Unit]
Description=Celery Worker Service for Django Library API
After=network.target redis.service postgresql.service

[Service]
Type=forking
User=www-data
Group=www-data
WorkingDirectory=/var/www/library-api

Environment="PATH=/var/www/library-api/venv/bin"
Environment="DJANGO_SETTINGS_MODULE=config.settings.production"

ExecStart=/var/www/library-api/venv/bin/celery -A config worker \
          --loglevel=info \
          --logfile=/var/log/celery/worker.log \
          --pidfile=/var/run/celery/worker.pid \
          --detach

ExecStop=/bin/kill -s TERM $MAINPID
ExecReload=/bin/kill -s HUP $MAINPID

Restart=always
RestartSec=10

# Create directories
RuntimeDirectory=celery
RuntimeDirectoryMode=0755
LogsDirectory=celery
LogsDirectoryMode=0755

[Install]
WantedBy=multi-user.target


# ============================================================================
# 5. CELERY BEAT SERVICE (Periodic Tasks)
# ============================================================================
# File: /etc/systemd/system/celerybeat.service
# Description: Celery beat scheduler

[Unit]
Description=Celery Beat Service for Django Library API
After=network.target redis.service

[Service]
Type=simple
User=www-data
Group=www-data
WorkingDirectory=/var/www/library-api

Environment="PATH=/var/www/library-api/venv/bin"
Environment="DJANGO_SETTINGS_MODULE=config.settings.production"

ExecStart=/var/www/library-api/venv/bin/celery -A config beat \
          --loglevel=info \
          --logfile=/var/log/celery/beat.log \
          --pidfile=/var/run/celery/beat.pid \
          --scheduler django_celery_beat.schedulers:DatabaseScheduler

Restart=always
RestartSec=10

RuntimeDirectory=celery
LogsDirectory=celery

[Install]
WantedBy=multi-user.target


# ============================================================================
# 6. CELERY FLOWER SERVICE (Monitoring)
# ============================================================================
# File: /etc/systemd/system/celery-flower.service
# Description: Celery Flower monitoring tool

[Unit]
Description=Celery Flower Monitoring for Django Library API
After=network.target redis.service celery.service

[Service]
Type=simple
User=www-data
Group=www-data
WorkingDirectory=/var/www/library-api

Environment="PATH=/var/www/library-api/venv/bin"
Environment="DJANGO_SETTINGS_MODULE=config.settings.production"

ExecStart=/var/www/library-api/venv/bin/celery -A config flower \
          --port=5555 \
          --broker=redis://localhost:6379/0

Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target

# Access Flower at: http://localhost:5555


# ============================================================================
# 7. DJANGO CHANNELS (WebSocket)
# ============================================================================
# File: /etc/systemd/system/daphne.service
# Description: Daphne ASGI server for Django Channels

[Unit]
Description=Daphne ASGI Server for Django Channels
After=network.target redis.service

[Service]
Type=simple
User=www-data
Group=www-data
WorkingDirectory=/var/www/library-api

Environment="PATH=/var/www/library-api/venv/bin"
Environment="DJANGO_SETTINGS_MODULE=config.settings.production"

ExecStart=/var/www/library-api/venv/bin/daphne \
          -u /run/daphne/daphne.sock \
          config.asgi:application

Restart=always
RestartSec=3

RuntimeDirectory=daphne
RuntimeDirectoryMode=0755

[Install]
WantedBy=multi-user.target


# ============================================================================
# 8. BACKUP SERVICE (Automated Backups)
# ============================================================================
# File: /etc/systemd/system/backup.service
# Description: Automated backup service

[Unit]
Description=Django API Automated Backup Service

[Service]
Type=oneshot
User=www-data
Group=www-data

ExecStart=/var/www/library-api/scripts/backup.sh

StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target


# ============================================================================
# 9. BACKUP TIMER (Daily Backups)
# ============================================================================
# File: /etc/systemd/system/backup.timer
# Description: Timer for automated backups

[Unit]
Description=Daily Backup Timer for Django API

[Timer]
# Run daily at 2:00 AM
OnCalendar=daily
OnCalendar=*-*-* 02:00:00

# Run 10 minutes after boot if missed
Persistent=true

[Install]
WantedBy=timers.target

# Enable timer:
# sudo systemctl enable backup.timer
# sudo systemctl start backup.timer


# ============================================================================
# 10. LOG ROTATION SERVICE
# ============================================================================
# File: /etc/systemd/system/log-rotation.service
# Description: Log rotation service

[Unit]
Description=Django API Log Rotation Service

[Service]
Type=oneshot
User=root

ExecStart=/usr/sbin/logrotate /etc/logrotate.d/library-api

StandardOutput=journal
StandardError=journal


# ============================================================================
# 11. LOG ROTATION TIMER
# ============================================================================
# File: /etc/systemd/system/log-rotation.timer
# Description: Timer for log rotation

[Unit]
Description=Weekly Log Rotation Timer

[Timer]
OnCalendar=weekly
Persistent=true

[Install]
WantedBy=timers.target


# ============================================================================
# SYSTEMD COMMANDS REFERENCE
# ============================================================================

# Enable service (start on boot)
# sudo systemctl enable gunicorn.service

# Start service
# sudo systemctl start gunicorn.service

# Stop service
# sudo systemctl stop gunicorn.service

# Restart service
# sudo systemctl restart gunicorn.service

# Reload service (reload config without restart)
# sudo systemctl reload gunicorn.service

# Check status
# sudo systemctl status gunicorn.service

# View logs
# sudo journalctl -u gunicorn.service

# Follow logs (live)
# sudo journalctl -u gunicorn.service -f

# View logs since boot
# sudo journalctl -u gunicorn.service -b

# View logs for specific time
# sudo journalctl -u gunicorn.service --since "2024-01-01 00:00:00"

# Reload systemd configuration
# sudo systemctl daemon-reload

# List all services
# sudo systemctl list-units --type=service

# List failed services
# sudo systemctl list-units --type=service --state=failed

# Check if service is enabled
# sudo systemctl is-enabled gunicorn.service

# Check if service is active
# sudo systemctl is-active gunicorn.service

# Disable service
# sudo systemctl disable gunicorn.service

# Mask service (prevent from being started)
# sudo systemctl mask gunicorn.service

# Unmask service
# sudo systemctl unmask gunicorn.service


# ============================================================================
# DEPENDENCIES AND ORDERING
# ============================================================================

# Common dependencies:
# After=network.target          - Start after network is up
# After=postgresql.service      - Start after PostgreSQL
# After=redis.service          - Start after Redis
# Requires=postgresql.service  - Fail if PostgreSQL fails
# Wants=redis.service         - Start Redis if available


# ============================================================================
# ENVIRONMENT VARIABLES
# ============================================================================

# Set environment variables:
# Environment="VAR=value"
# Environment="VAR1=value1" "VAR2=value2"

# Load from file:
# EnvironmentFile=/path/to/.env


# ============================================================================
# RESTART POLICIES
# ============================================================================

# Restart=no              - Don't restart
# Restart=on-success      - Restart only on clean exit
# Restart=on-failure      - Restart only on failure
# Restart=on-abnormal     - Restart on abnormal exit
# Restart=on-watchdog     - Restart on watchdog timeout
# Restart=on-abort        - Restart on unclean signal
# Restart=always          - Always restart


# ============================================================================
# SECURITY OPTIONS
# ============================================================================

# NoNewPrivileges=true           - Prevent privilege escalation
# ProtectSystem=strict           - Make /usr, /boot, /efi read-only
# ProtectSystem=full            - Make /usr, /boot read-only
# ProtectHome=true              - Make /home inaccessible
# PrivateTmp=true               - Private /tmp directory
# ReadWritePaths=/path          - Allow write to specific paths
# ReadOnlyPaths=/path           - Make specific paths read-only


# ============================================================================
# RESOURCE LIMITS
# ============================================================================

# LimitNOFILE=65535              - Max open files
# LimitNPROC=4096                - Max processes
# LimitCPU=infinity              - CPU time limit
# LimitAS=infinity               - Address space limit
# LimitMEMLOCK=64M              - Memory lock limit
# CPUQuota=50%                  - CPU usage limit
# MemoryLimit=2G                - Memory limit


# ============================================================================
# LOGGING
# ============================================================================

# StandardOutput=journal         - Log stdout to journal
# StandardError=journal          - Log stderr to journal
# StandardOutput=file:/path      - Log stdout to file
# StandardError=file:/path       - Log stderr to file
# SyslogIdentifier=myapp        - Identifier for syslog


# ============================================================================
# EXAMPLE: Complete Production Setup
# ============================================================================

# 1. Copy service files
# sudo cp gunicorn.service /etc/systemd/system/
# sudo cp celery.service /etc/systemd/system/
# sudo cp celerybeat.service /etc/systemd/system/
# sudo cp backup.service /etc/systemd/system/
# sudo cp backup.timer /etc/systemd/system/

# 2. Reload systemd
# sudo systemctl daemon-reload

# 3. Enable services
# sudo systemctl enable gunicorn.service
# sudo systemctl enable celery.service
# sudo systemctl enable celerybeat.service
# sudo systemctl enable backup.timer

# 4. Start services
# sudo systemctl start gunicorn.service
# sudo systemctl start celery.service
# sudo systemctl start celerybeat.service
# sudo systemctl start backup.timer

# 5. Check status
# sudo systemctl status gunicorn.service
# sudo systemctl status celery.service
# sudo systemctl status celerybeat.service
# sudo systemctl list-timers

# 6. Monitor logs
# sudo journalctl -u gunicorn.service -f