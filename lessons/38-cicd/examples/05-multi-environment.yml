# =============================================================================
# Multi-Environment Deployment Workflow
# =============================================================================
# Purpose: Deploy to Staging and Production environments
# Complexity: Expert â­â­â­â­
# Features:
#   - Develop branch â†’ Staging
#   - Main branch â†’ Production
#   - Environment-specific secrets
#   - Manual approval for production
#   - Rollback capability
#   - Environment URLs
# =============================================================================

name: Multi-Environment Deploy

on:
  push:
    branches:
      - develop    # Triggers staging deployment
      - main       # Triggers production deployment
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  # ===========================================================================
  # JOB 1: Deploy to Staging
  # ===========================================================================
  deploy-staging:
    if: github.ref == 'refs/heads/develop' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://library-api-staging.up.railway.app
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      
      - name: Deploy to Staging
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_STAGING_TOKEN }}
        run: |
          echo "ğŸš€ Deploying to STAGING..."
          railway up --service library-api-staging
      
      - name: Run migrations (Staging)
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_STAGING_TOKEN }}
        run: |
          echo "ğŸ“Š Running migrations on STAGING..."
          railway run python manage.py migrate --noinput
      
      - name: Collect static files (Staging)
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_STAGING_TOKEN }}
        run: |
          echo "ğŸ“¦ Collecting static files on STAGING..."
          railway run python manage.py collectstatic --noinput
      
      - name: Run smoke tests (Staging)
        run: |
          echo "ğŸ§ª Running smoke tests..."
          sleep 10
          curl -f https://library-api-staging.up.railway.app/health/ || exit 1
          echo "âœ… Smoke tests passed"
      
      - name: Staging deployment summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… STAGING Deployment Successful!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ URL: https://library-api-staging.up.railway.app"
          echo "ğŸŒ¿ Branch: develop"
          echo "ğŸ“Š Migrations: âœ…"
          echo "ğŸ“¦ Static: âœ…"
          echo "ğŸ§ª Tests: âœ…"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # ===========================================================================
  # JOB 2: Deploy to Production
  # ===========================================================================
  deploy-production:
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://library-api.up.railway.app
    
    # Production requires manual approval (configured in GitHub)
    # Settings â†’ Environments â†’ production â†’ Required reviewers
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      
      - name: Create deployment backup
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_PRODUCTION_TOKEN }}
        run: |
          echo "ğŸ’¾ Creating backup before deployment..."
          railway run python manage.py dumpdata > backup-$(date +%Y%m%d-%H%M%S).json || true
      
      - name: Deploy to Production
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_PRODUCTION_TOKEN }}
        run: |
          echo "ğŸš€ Deploying to PRODUCTION..."
          railway up --service library-api-production
      
      - name: Run migrations (Production)
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_PRODUCTION_TOKEN }}
        run: |
          echo "ğŸ“Š Running migrations on PRODUCTION..."
          railway run python manage.py migrate --noinput
      
      - name: Collect static files (Production)
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_PRODUCTION_TOKEN }}
        run: |
          echo "ğŸ“¦ Collecting static files on PRODUCTION..."
          railway run python manage.py collectstatic --noinput
      
      - name: Warm up cache (Production)
        run: |
          echo "ğŸ”¥ Warming up application cache..."
          curl -s https://library-api.up.railway.app/api/books/ > /dev/null || true
          echo "âœ… Cache warmed up"
      
      - name: Run smoke tests (Production)
        run: |
          echo "ğŸ§ª Running production smoke tests..."
          sleep 15
          
          # Health check
          curl -f https://library-api.up.railway.app/health/ || exit 1
          
          # API check
          curl -f https://library-api.up.railway.app/api/books/ || exit 1
          
          # Admin check
          curl -f https://library-api.up.railway.app/admin/ || exit 1
          
          echo "âœ… All smoke tests passed"
      
      - name: Production deployment summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ PRODUCTION Deployment Successful!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ URL: https://library-api.up.railway.app"
          echo "ğŸŒ³ Branch: main"
          echo "ğŸ’¾ Backup: âœ…"
          echo "ğŸ“Š Migrations: âœ…"
          echo "ğŸ“¦ Static: âœ…"
          echo "ğŸ”¥ Cache: âœ…"
          echo "ğŸ§ª Tests: âœ…"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ PRODUCTION deployment failed!"
          echo "Please check logs and consider rollback"

# =============================================================================
# GitHub Environments Setup:
# =============================================================================
#
# 1. Create Staging Environment:
#    - Repository â†’ Settings â†’ Environments
#    - New environment â†’ Name: "staging"
#    - Add secrets:
#      * RAILWAY_STAGING_TOKEN
#    - Environment URL: https://library-api-staging.up.railway.app
#
# 2. Create Production Environment:
#    - New environment â†’ Name: "production"
#    - Add secrets:
#      * RAILWAY_PRODUCTION_TOKEN
#    - Environment URL: https://library-api.up.railway.app
#    - Protection rules:
#      âœ“ Required reviewers: [select team members]
#      âœ“ Wait timer: 5 minutes (optional)
#      âœ“ Allow administrators to bypass
#
# =============================================================================
# Railway Services Setup:
# =============================================================================
#
# 1. Create Staging Service:
#    - Railway â†’ New Service
#    - Name: library-api-staging
#    - Connect to GitHub branch: develop
#    - Environment variables:
#      * DJANGO_SETTINGS_MODULE=library_project.settings.staging
#      * DEBUG=True (for staging)
#      * ALLOWED_HOSTS=*.railway.app
#
# 2. Create Production Service:
#    - Railway â†’ New Service
#    - Name: library-api-production
#    - Connect to GitHub branch: main
#    - Environment variables:
#      * DJANGO_SETTINGS_MODULE=library_project.settings.production
#      * DEBUG=False
#      * ALLOWED_HOSTS=library-api.up.railway.app
#      * Add all production secrets
#
# =============================================================================
# Branch Strategy:
# =============================================================================
#
# develop branch (Staging):
#   - Development work
#   - Feature branches merge here
#   - Auto-deploys to staging
#   - No manual approval needed
#   - Testing ground
#
# main branch (Production):
#   - Production-ready code only
#   - develop merges here after testing
#   - Requires manual approval
#   - Protected branch
#   - Stable releases
#
# Workflow:
#   Feature â†’ develop â†’ Staging â†’ Test â†’ main â†’ Production
#
# =============================================================================
# Approval Workflow:
# =============================================================================
#
# When code pushed to main:
#   1. Workflow starts
#   2. Waits for approval (if configured)
#   3. Reviewer gets notification
#   4. Reviewer approves/rejects
#   5. If approved: deployment continues
#   6. If rejected: deployment canceled
#
# Configure reviewers:
#   Settings â†’ Environments â†’ production â†’ Required reviewers
#
# =============================================================================
# Testing Strategy:
# =============================================================================
#
# Staging Tests:
#   âœ“ Health check
#   âœ“ Basic smoke tests
#   âœ“ Fast and automated
#
# Production Tests:
#   âœ“ Health check
#   âœ“ API endpoints
#   âœ“ Admin panel
#   âœ“ More comprehensive
#   âœ“ Cache warming
#
# =============================================================================
# Rollback Strategy:
# =============================================================================
#
# Staging Rollback:
#   - Fast rollback acceptable
#   - Test rollback procedures
#   - railway rollback
#
# Production Rollback:
#   - Use backup created before deployment
#   - railway rollback
#   - Or redeploy previous commit:
#     git revert HEAD
#     git push origin main
#
# =============================================================================
# Environment Variables Comparison:
# =============================================================================
#
# Staging:
#   DEBUG=True (for debugging)
#   ALLOWED_HOSTS=*.railway.app
#   DATABASE_URL=staging-db-url
#   SECRET_KEY=staging-secret
#   SENTRY_ENVIRONMENT=staging
#
# Production:
#   DEBUG=False (security)
#   ALLOWED_HOSTS=library-api.up.railway.app
#   DATABASE_URL=production-db-url
#   SECRET_KEY=production-secret (different!)
#   SENTRY_ENVIRONMENT=production
#
# =============================================================================
# Manual Deployment:
# =============================================================================
#
# Trigger manually:
#   1. GitHub â†’ Actions
#   2. Multi-Environment Deploy â†’ Run workflow
#   3. Select branch: develop or main
#   4. Select environment: staging or production
#   5. Run workflow
#
# =============================================================================
# Monitoring:
# =============================================================================
#
# After deployment, monitor:
#   - Railway logs: railway logs
#   - Application metrics
#   - Error tracking (Sentry)
#   - User reports
#   - Health check endpoint
#
# =============================================================================
# Expected Output:
# =============================================================================
#
# Staging deployment (develop branch):
#   âœ… Deploy to Staging
#   âœ… Run migrations
#   âœ… Collect static
#   âœ… Smoke tests
#   âœ… Summary
#
# Production deployment (main branch):
#   â¸ï¸ Waiting for approval...
#   âœ… Approved
#   ğŸ’¾ Backup created
#   âœ… Deploy to Production
#   âœ… Run migrations
#   âœ… Collect static
#   ğŸ”¥ Cache warmed
#   âœ… Smoke tests passed
#   âœ… Summary
#
# =============================================================================